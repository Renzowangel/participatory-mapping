<!DOCTYPE html>
<html>

<head>
    <title>A Minimum Viable Participatory Mapping Project</title>
    <script src="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.css" rel="stylesheet" />
    <!-- Styles for the map and popup -->
    <style>
        /* Basic CSS for the page */
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        #info {
            position: absolute;
            top: 120px;
            left: 0;
            width: 450px;
            margin: 10px;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 5px;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 15px;
            line-height: 1.5;
            color: #000000;
            z-index: 1;
        }
        
        #popup {
            padding: 10px;
        }

        #name {
            width: 100%;
            height: 20px;
            margin-bottom: 10px;
        }

        #content {
            width: 100%;
            height: 45px;
            margin-bottom: 10px;
        }

        #submit {
            float: right;
            
        }
    </style>
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Shifting LGBTQ+ Spaces</title>
      <style type="text/css">svg:not(:root).svg-inline--fa{overflow:visible}.svg-inline--fa{display:inline-block;font-size:inherit;height:1em;overflow:visible;vertical-align:-.125em}.svg-inline--fa.fa-lg{vertical-align:-.225em}.svg-inline--fa.fa-w-1{width:.0625em}.svg-inline--fa.fa-w-2{width:.125em}.svg-inline--fa.fa-w-3{width:.1875em}.svg-inline--fa.fa-w-4{width:.25em}.svg-inline--fa.fa-w-5{width:.3125em}.svg-inline--fa.fa-w-6{width:.375em}.svg-inline--fa.fa-w-7{width:.4375em}.svg-inline--fa.fa-w-8{width:.5em}.svg-inline--fa.fa-w-9{width:.5625em}.svg-inline--fa.fa-w-10{width:.625em}.svg-inline--fa.fa-w-11{width:.6875em}.svg-inline--fa.fa-w-12{width:.75em}.svg-inline--fa.fa-w-13{width:.8125em}.svg-inline--fa.fa-w-14{width:.875em}.svg-inline--fa.fa-w-15{width:.9375em}.svg-inline--fa.fa-w-16{width:1em}.svg-inline--fa.fa-w-17{width:1.0625em}.svg-inline--fa.fa-w-18{width:1.125em}.svg-inline--fa.fa-w-19{width:1.1875em}.svg-inline--fa.fa-w-20{width:1.25em}.svg-inline--fa.fa-pull-left{margin-right:.3em;width:auto}.svg-inline--fa.fa-pull-right{margin-left:.3em;width:auto}.svg-inline--fa.fa-border{height:1.5em}.svg-inline--fa.fa-li{width:2em}.svg-inline--fa.fa-fw{width:1.25em}.fa-layers svg.svg-inline--fa{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.fa-layers{display:inline-block;height:1em;position:relative;text-align:center;vertical-align:-.125em;width:1em}.fa-layers svg.svg-inline--fa{-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter,.fa-layers-text{display:inline-block;position:absolute;text-align:center}.fa-layers-text{left:50%;top:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter{background-color:#ff253a;border-radius:1em;-webkit-box-sizing:border-box;box-sizing:border-box;color:#fff;height:1.5em;line-height:1;max-width:5em;min-width:1.5em;overflow:hidden;padding:.25em;right:0;text-overflow:ellipsis;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-bottom-right{bottom:0;right:0;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom right;transform-origin:bottom right}.fa-layers-bottom-left{bottom:0;left:0;right:auto;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom left;transform-origin:bottom left}.fa-layers-top-right{right:0;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-top-left{left:0;right:auto;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top left;transform-origin:top left}.fa-lg{font-size:1.3333333333em;line-height:.75em;vertical-align:-.0667em}.fa-xs{font-size:.75em}.fa-sm{font-size:.875em}.fa-1x{font-size:1em}.fa-2x{font-size:2em}.fa-3x{font-size:3em}.fa-4x{font-size:4em}.fa-5x{font-size:5em}.fa-6x{font-size:6em}.fa-7x{font-size:7em}.fa-8x{font-size:8em}.fa-9x{font-size:9em}.fa-10x{font-size:10em}.fa-fw{text-align:center;width:1.25em}.fa-ul{list-style-type:none;margin-left:2.5em;padding-left:0}.fa-ul>li{position:relative}.fa-li{left:-2em;position:absolute;text-align:center;width:2em;line-height:inherit}.fa-border{border:solid .08em #eee;border-radius:.1em;padding:.2em .25em .15em}.fa-pull-left{float:left}.fa-pull-right{float:right}.fa.fa-pull-left,.fab.fa-pull-left,.fal.fa-pull-left,.far.fa-pull-left,.fas.fa-pull-left{margin-right:.3em}.fa.fa-pull-right,.fab.fa-pull-right,.fal.fa-pull-right,.far.fa-pull-right,.fas.fa-pull-right{margin-left:.3em}.fa-spin{-webkit-animation:fa-spin 2s infinite linear;animation:fa-spin 2s infinite linear}.fa-pulse{-webkit-animation:fa-spin 1s infinite steps(8);animation:fa-spin 1s infinite steps(8)}@-webkit-keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}.fa-rotate-90{-webkit-transform:rotate(90deg);transform:rotate(90deg)}.fa-rotate-180{-webkit-transform:rotate(180deg);transform:rotate(180deg)}.fa-rotate-270{-webkit-transform:rotate(270deg);transform:rotate(270deg)}.fa-flip-horizontal{-webkit-transform:scale(-1,1);transform:scale(-1,1)}.fa-flip-vertical{-webkit-transform:scale(1,-1);transform:scale(1,-1)}.fa-flip-both,.fa-flip-horizontal.fa-flip-vertical{-webkit-transform:scale(-1,-1);transform:scale(-1,-1)}:root .fa-flip-both,:root .fa-flip-horizontal,:root .fa-flip-vertical,:root .fa-rotate-180,:root .fa-rotate-270,:root .fa-rotate-90{-webkit-filter:none;filter:none}.fa-stack{display:inline-block;height:2em;position:relative;width:2.5em}.fa-stack-1x,.fa-stack-2x{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.svg-inline--fa.fa-stack-1x{height:1em;width:1.25em}.svg-inline--fa.fa-stack-2x{height:2em;width:2.5em}.fa-inverse{color:#fff}.sr-only{border:0;clip:rect(0,0,0,0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.sr-only-focusable:active,.sr-only-focusable:focus{clip:auto;height:auto;margin:0;overflow:visible;position:static;width:auto}.svg-inline--fa .fa-primary{fill:var(--fa-primary-color,currentColor);opacity:1;opacity:var(--fa-primary-opacity,1)}.svg-inline--fa .fa-secondary{fill:var(--fa-secondary-color,currentColor);opacity:.4;opacity:var(--fa-secondary-opacity,.4)}.svg-inline--fa.fa-swap-opacity .fa-primary{opacity:.4;opacity:var(--fa-secondary-opacity,.4)}.svg-inline--fa.fa-swap-opacity .fa-secondary{opacity:1;opacity:var(--fa-primary-opacity,1)}.svg-inline--fa mask .fa-primary,.svg-inline--fa mask .fa-secondary{fill:#000}.fad.fa-inverse{color:#fff}</style><link rel="icon" type="image/x-icon" href="assets/imgs/logo.png">
      <!-- <link href="css/bootstrap.min.css" rel="stylesheet"> -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
      <link href="https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.css" rel="stylesheet">
      <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css" type="text/css">
      <link rel="stylesheet" href="css/font-awesome-4.7.0/css/font-awesome.min.css">
      <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/6.0.0/introjs.min.css">
      <link rel="stylesheet" href="css/simplebar.css">
      <!-- threebox -->
      <script src="./js/threebox.js"></script>
      <script src="./js/config.js"></script>
    
      <!-- Custom CSS Styling -->
      <link href="css/common.css" rel="stylesheet">
      <link href="css/main.css" rel="stylesheet">
    
      <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
      <!-- bootstrap 4.6 is required for bootstrap-select, a feature used in the platform -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous">
      </script>
      <!-- bootstrap 5.1 is required for the overall structure of the platform -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" crossorigin="anonymous">
      </script>
    
      <script src="https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.js"></script>
    
      <!-- font awesome kit -->
      <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>
    
      <!-- Load the `mapbox-gl-geocoder` plugin. -->
      <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js">
      </script>
    
      <!-- Promise polyfill script is required -->
      <!-- to use MapBox GL Geocoder in IE 11. -->
      <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
    
      <!-- chroma.js for color scales -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.2/chroma.min.js"></script>
    
      <!-- google font -->
      <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,800" rel="stylesheet">
    
      <!-- Latest compiled and minified JavaScript -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    
      <!-- turf js  -->
      <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/6.0.0/intro.min.js"></script>
      <script src="js/main.js"></script>
    <script type="text/javascript" charset="UTF-8" src="https://maps.googleapis.com/maps-api-v3/api/js/56/12a/intl/zh_cn/common.js"></script><script type="text/javascript" charset="UTF-8" src="https://maps.googleapis.com/maps-api-v3/api/js/56/12a/intl/zh_cn/util.js"></script></head>
</head>

<body>
    <!-- Map container -->
    <div id="map"></div>
    
    <!-- Information box -->
    <div id="info">
        <h3>巫山脆李农业可视化</h3>
        <h4>重庆科技大学 王一然，陈浩，朱章雄等</h4>
        <!-- Introduction to the participatory mapping solution -->
        <p>该地图是“基于Critical GIS的土地质量地质调查插值方法研究”项目的参与式制图实践。用户可以通过点击地图来贡献他们的本地知识，提交他们的信息，并查看它（以红点表示）。可实现的功能包括：可视化各个果园及的位置和不同品种果实的种植区域，收集果苗采购、果实分销的站点信息等。现有贡献也可以被在地图上显示为红点。为了帮助您设想这张地图可以为您提供什么帮助，您可以查看本项目内容,
            同时，您也可以 
            <a href="https://github.com/Renzowangel/participatory-mapping" target="_blank">在此处</a>.
            联系项目负责人
            <i>最后更新：2024年 4 月 26 日</i>
        </p> 
    </div>
    
    <!-- JavaScript code for the interactive map and data submission -->
    <script>
        // Variable to hold the popup instance
        let popup = null;
        
        // GeoJSON data object to store the contributed points
        let geojson = {
            'type': 'FeatureCollection',
            'features': []
        };
        
        // Create a new map instance
        let map = new maplibregl.Map({
            container: 'map', // container id
            style: 'https://api.maptiler.com/maps/streets-v2/style.json?key=Cusoe5zmfmn26glFoeoe', // style URL
            center: [109.6500, 31.0159], // starting position [lng, lat]
            // pitch: 45, // pitch in degrees
            zoom: 12 // starting zoom
        });

        // Fetch existing records when the window is loaded
        window.addEventListener("load", async function () {
            let response = await fetch('https://pmap-28a9a9408e2b.herokuapp.com/api/get-record', {
                method: 'GET'
            });

            let data = await response.json();
      
            // Iterate through the fetched records and add them to the GeoJSON data object
            for (let i = 0; i < data.rows.length; i++) {
                geojson.features.push({
                    'type': 'Feature',
                    'properties': {
                        'contributor': data.rows[i].contributor,
                        'content': data.rows[i].content,
                    },
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [data.rows[i].lng, data.rows[i].lat]
                    }
                });
            }
        });

        // After the map loads, add the GeoJSON source and layer for existing points
        map.on("load", function () {
            map.addSource('places', {
                'type': 'geojson',
                'data': geojson
            });

            map.addLayer({
                'id': 'placesLayer',
                'type': 'circle',
                'source': 'places',
                'paint': {
                    'circle-radius': 6,
                    'circle-color': '#B42222'
                }
            });
        });

        // Show popup on mouse enter over an existing point
        map.on('mouseenter', 'placesLayer', function (e) {
            map.getCanvas().style.cursor = 'pointer';

            var coordinates = e.features[0].geometry.coordinates;
            var content = e.features[0].properties.content;
            var contributor = e.features[0].properties.contributor;

            popup = new maplibregl.Popup()
                .setLngLat(coordinates)
                .setHTML("<p><b>" + contributor + "</b> <i>said:</i> " + content + "</p>")
                .addTo(map);
        });

        // Remove popup on mouse leave from an existing point
        map.on('mouseleave', 'placesLayer', function () {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });

        // Handle click event on the map to allow user contribution
        map.on('click', function (e) {
            if (popup) {
                popup.remove();
            }

            // Create the HTML content for the contribution popup
            const popupContent = '<div id="popup"><input type="text" id="name" placeholder="Input your name here..."><input type="text" id="content" placeholder="Input your message here..."><button id="submit">submit</button></div>';

            // Create a new popup and set its content
            popup = new maplibregl.Popup({ closeOnClick: false })
                .setLngLat(e.lngLat)
                .setHTML(popupContent)
                .addTo(map);

            // Attach an event listener to the submit button to handle new record submission
            document.getElementById('submit').addEventListener('click', submitNewRecord);
            e.preventDefault();
        });

        // Function to handle the submission of a new record
        async function submitNewRecord() {
            let contributor = document.getElementById('name').value;
            let content = document.getElementById('content').value;
            let lngLat = popup.getLngLat();

            // Create a new URLSearchParams object and append the data to it
            let newRecord = new URLSearchParams();
            newRecord.append('contributor', contributor);
            newRecord.append('content', content);
            newRecord.append('lng', lngLat.lng);
            newRecord.append('lat', lngLat.lat);

            // Set the POST request settings
            let settings = {
                method: 'POST',
                body: newRecord
            }

            try {
                // Send the POST request to add the new record
                await fetch('https://pmap-28a9a9408e2b.herokuapp.com/api/add-record', settings);
            } catch (err) {
                // Handle any errors that occur during the request
                console.error(err);
            } finally {
                // Remove the popup and update the GeoJSON data with the new point
                popup.remove();
                geojson.features.push({
                    'type': 'Feature',
                    'properties': {
                        'contributor': contributor,
                        'content': content,
                    },
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [lngLat.lng, lngLat.lat]
                    }
                });
                map.getSource('places').setData(geojson);
            }
        }
    </script>
<nav class="navbar navbar-expand  navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="img/CQUST.png">

      </a>

      <div id="navbar-tabs">
        <ul class="navbar-nav me-auto mb-2 mb-md-0">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="about.html">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="#">Map</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="data.html">Data</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="methodology.html">Design &amp; Methodology</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="ethics.html">Ethics</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="team.html">Team</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" data-intro="submit your feedback of your comments to this platform." data-step="1" target="_blank" href="feedback.html">Feedback</a>
          </li>



            <!-- Button trigger modal -->
           

                    </div>
                  </div>
                
                </div>
              </div>
            </div>
          </li>
        </ul>
      </div>


          

    
        </ul>
      </div>
    </div>
  </nav>

</body>

</html>
